<!DOCTYPE html>
<html>
    <head>
        <script src="./edge-impulse-standalone.js"></script>
        <script src="./run-impulse.js"></script>
        
        <style>
            #results {
                white-space: pre-wrap;
                font-family: monospace;
                background: #f4f4f4;
                padding: 10px;
                border: 1px solid #ccc;
            }
            .container {
                display: flex;
                flex-direction: column;
                align-items: center;
                margin-top: 20px;
            }
            #video {
                border: 2px solid #007bff;
                margin-bottom: 10px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>T1A15 Edge Impulse Model Demo</h1>
            
            
            <button id="start-webcam">Start Webcam & Run Model</button>
            <video id="video" width="320" height="240" autoplay muted></video>
            <canvas id="canvas" width="96" height="96" style="display:none;"></canvas>
            
            <h3>Results:</h3>
            <pre id="results">Click 'Start Webcam' to begin classification...</pre>
        </div>

        <script>

            const IMAGE_WIDTH = 96;
            const IMAGE_HEIGHT = 96;
            const INFERENCE_INTERVAL_MS = 1000; 


            document.getElementById('start-webcam').addEventListener('click', async () => {
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                const ctx = canvas.getContext('2d');
                const results = document.getElementById('results');


                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    results.textContent = 'Error: Webcam access not supported by your browser.';
                    return;
                }
                
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { width: 320, height: 240 } 
                    });
                    video.srcObject = stream;
                } catch (err) {
                    results.textContent = 'Error accessing webcam: ' + err.name + '. Please ensure your browser has permission.';
                    return;
                }
                
                await new Promise(resolve => video.onloadedmetadata = resolve);


                results.textContent = 'Webcam started. Model running...';

                setInterval(() => {

                    ctx.drawImage(video, 0, 0, IMAGE_WIDTH, IMAGE_HEIGHT);
                    
                    const imageData = ctx.getImageData(0, 0, IMAGE_WIDTH, IMAGE_HEIGHT);
                    
                    runImpulse(imageData)
                        .then(res => {
                            const output = {
                                success: res.success,
                                classification: res.results.map(r => ({
                                    label: r.label,
                                    score: r.value.toFixed(4)
                                }))
                            };
                            results.textContent = JSON.stringify(output, null, 2);
                        })
                        .catch(err => {
                            results.textContent = 'Fatal Error during WASM inference: ' + err;
                            clearInterval(this);
                        });

                }, INFERENCE_INTERVAL_MS);
            });
        </script>
    </body>
</html>
