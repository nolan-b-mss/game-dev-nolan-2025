<!DOCTYPE html>
<html>
    <head>
        <title>T1A15 Edge Impulse Model Demo (Final Fix)</title>
        <script src="./edge-impulse-standalone.js"></script>
        <script src="./run-impulse.js"></script>
        
        <style>
            #results {
                white-space: pre-wrap;
                font-family: monospace;
                background: #f4f4f4;
                padding: 10px;
                border: 1px solid #ccc;
            }
            .container {
                display: flex;
                flex-direction: column;
                align-items: center;
                margin-top: 20px;
            }
            #video {
                /* Set height to 0 to hide the video placeholder when no webcam is present */
                height: 0; 
                border: none;
                margin-bottom: 0;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>T1A15 Edge Impulse Model Demo (Verified Working)</h1>
            <p>Model runs using the highly compatible WebAssembly runtime.</p>
            
            <button id="start-model">Start Classification</button>
            <video id="video" width="320" height="240" autoplay muted></video>
            <canvas id="canvas" width="96" height="96" style="display:none;"></canvas>
            
            <h3>Results:</h3>
            <pre id="results">Click 'Start Classification' to run the model on a dummy array...</pre>
        </div>

<script>
    // Instantiate the classifier globally
    const ei_classifier = new EdgeImpulseClassifier();

    const IMAGE_WIDTH = 96;
    const IMAGE_HEIGHT = 96;
    const INFERENCE_INTERVAL_MS = 1000;  

    document.getElementById('start-model').addEventListener('click', async () => {
        const results = document.getElementById('results');

        // 1. CRITICAL FIX: Initialize the WASM model and WAIT for it to load.
        results.textContent = 'Initializing model... please wait.';
        try {
            await ei_classifier.init();
        } catch (err) {
            results.textContent = 'ERROR: Failed to initialize Edge Impulse model. ' + err;
            return;
        }

        // 2. Start Classification Loop
        results.textContent = 'Model running on dummy data...';

        const inferenceInterval = setInterval(() => {
            
            // 1. CRITICAL FINAL FIX: Create Float32Array (1-channel, Normalized 0-1)
            const totalPixels = IMAGE_WIDTH * IMAGE_HEIGHT;
            const rawFloatData = new Float32Array(totalPixels);
            
            // 2. Fill with NON-UNIFORM data (half black, half white) to prevent silent model crash
            const halfPixels = totalPixels / 2;

            for (let i = 0; i < totalPixels; i++) {
                // Top half pixels are black (0.0), bottom half are white (1.0)
                rawFloatData[i] = (i < halfPixels) ? 0.0 : 1.0; 
            }

            // 3. Pass the correctly formatted Float32Array
            ei_classifier.classify(rawFloatData)
                .then(res => {
                    const output = {
                        success: res.success,
                        classification: res.results.map(r => ({
                            label: r.label,
                            score: r.value.toFixed(4)
                        }))
                    };
                    results.textContent = JSON.stringify(output, null, 2);
                })
                .catch(err => {
                    // Stop the loop if a fatal error occurs inside the model
                    results.textContent = 'FATAL ERROR inside WASM: ' + err;
                    clearInterval(inferenceInterval); 
                });

        }, INFERENCE_INTERVAL_MS);
    });
</script>
    </body>
</html>
